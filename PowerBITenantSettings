<#
Created by claude AI
to be reviewed!
#>

# ============================================================================
# Power BI Tenant Settings Inventory - FABRIC API VERSION
# ============================================================================

# HELPER FUNCTION - Must be at the top
function Get-SettingCategory {
    param([string]$settingName)
    
    switch -Wildcard ($settingName) {
        "*Export*" { "Export & Sharing" }
        "*Share*" { "Export & Sharing" }
        "*Publish*" { "Export & Sharing" }
        "*Admin*" { "Admin & API" }
        "*API*" { "Admin & API" }
        "*ServicePrincipal*" { "Admin & API" }
        "*Metadata*" { "Admin & API" }
        "*Workspace*" { "Workspace Management" }
        "*Capacity*" { "Capacity & Performance" }
        "*Dataflow*" { "Dataflows & Datasets" }
        "*Dataset*" { "Dataflows & Datasets" }
        "*Template*" { "Development" }
        "*CustomVisual*" { "Development" }
        "*RScript*" { "Development" }
        "*Python*" { "Development" }
        "*Email*" { "Notifications" }
        "*Subscription*" { "Notifications" }
        "*Guest*" { "Security & Access" }
        "*External*" { "Security & Access" }
        "*B2B*" { "Security & Access" }
        "*InformationProtection*" { "Security & Access" }
        "*Sensitivity*" { "Security & Access" }
        "*Certification*" { "Governance" }
        "*Endorsement*" { "Governance" }
        "*Discovery*" { "Governance" }
        default { "Other" }
    }
}

$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$reportDate = Get-Date -Format "MMMM dd, yyyy HH:mm"

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "POWER BI TENANT SETTINGS EXPORT" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

# Connect using Azure Account
Write-Host "Connecting to Azure..." -ForegroundColor Yellow
Connect-AzAccount

# Get token for Fabric API
Write-Host "Getting access token..." -ForegroundColor Yellow
$tokenResponse = Get-AzAccessToken -ResourceUrl "https://api.fabric.microsoft.com"
$token = $tokenResponse.Token

Write-Host "‚úì Token acquired`n" -ForegroundColor Green

# Get all tenant settings
Write-Host "Retrieving tenant settings from Fabric API..." -ForegroundColor Yellow

try {
    $response = Invoke-RestMethod `
        -Uri "https://api.fabric.microsoft.com/v1/admin/tenantsettings" `
        -Method Get `
        -Headers @{ Authorization = "Bearer $token" }
    
    Write-Host "‚úì Retrieved $($response.tenantSettings.Count) settings`n" -ForegroundColor Green
}
catch {
    Write-Host "‚úó Failed to retrieve settings: $($_.Exception.Message)" -ForegroundColor Red
    exit
}

# ============================================================================
# PARSE AND STRUCTURE SETTINGS
# ============================================================================

Write-Host "Processing settings..." -ForegroundColor Yellow

$allSettings = foreach ($setting in $response.tenantSettings) {
    
    # Determine who can use this setting
    $enabledFor = if ($setting.enabled -eq $true) {
        if ($setting.canSpecifySecurityGroups -eq $true) {
            if ($setting.tenantSettingGroup) {
                # Has specific groups
                $groupNames = ($setting.tenantSettingGroup | ForEach-Object { $_.groupName }) -join "; "
                "Specific Groups: $groupNames"
            }
            elseif ($setting.excludedSecurityGroups) {
                # Excluded groups (enabled for all EXCEPT these)
                $excludedNames = ($setting.excludedSecurityGroups | ForEach-Object { $_.groupName }) -join "; "
                "All Users (except: $excludedNames)"
            }
            else {
                "Entire Organization"
            }
        }
        else {
            "Entire Organization"
        }
    }
    elseif ($setting.enabled -eq $false) {
        "Disabled"
    }
    else {
        "Not Configured"
    }
    
    # Get delegated tenant setting groups if applicable
    $delegatedTo = if ($setting.delegatedToUsers) {
        ($setting.delegatedToUsers | ForEach-Object { $_.groupName }) -join "; "
    }
    else {
        "N/A"
    }
    
    # Additional properties (some settings have extra config)
    $properties = if ($setting.properties) {
        ($setting.properties | ForEach-Object { "$($_.name): $($_.value)" }) -join "; "
    }
    else {
        ""
    }
    
    [PSCustomObject]@{
        SettingName              = $setting.settingName
        Title                    = $setting.title
        Enabled                  = $setting.enabled
        EnabledFor               = $enabledFor
        CanSpecifySecurityGroups = $setting.canSpecifySecurityGroups
        DelegatedToUsers         = $delegatedTo
        Category                 = Get-SettingCategory -settingName $setting.settingName
        AdditionalProperties     = $properties
    }
}

# ============================================================================
# EXPORT TO CSV
# ============================================================================

$csvPath = "PowerBI_TenantSettings_$timestamp.csv"
$allSettings | Export-Csv -Path $csvPath -NoTypeInformation -Encoding UTF8

Write-Host "‚úì Settings exported to CSV: $csvPath`n" -ForegroundColor Green

# ============================================================================
# ANALYSIS - Category Summary
# ============================================================================

Write-Host "Analyzing settings by category..." -ForegroundColor Yellow

$categorySummary = $allSettings | Group-Object Category | ForEach-Object {
    $enabled = ($_.Group | Where-Object { $_.Enabled -eq $true }).Count
    $disabled = ($_.Group | Where-Object { $_.Enabled -eq $false }).Count
    
    [PSCustomObject]@{
        Category = $_.Name
        Total = $_.Count
        Enabled = $enabled
        Disabled = $disabled
        EnabledPercentage = [Math]::Round(($enabled / $_.Count) * 100, 1)
    }
} | Sort-Object Category

# ============================================================================
# ANALYSIS - Critical Settings Check
# ============================================================================

Write-Host "Checking critical settings..." -ForegroundColor Yellow

$criticalSettings = @()

# Admin API settings
$adminApiSetting = $allSettings | Where-Object { 
    $_.SettingName -like "*ServicePrincipalAccess*" -or 
    $_.Title -like "*service principals*read-only admin*"
} | Select-Object -First 1

$criticalSettings += [PSCustomObject]@{
    Setting = "Service principals - Admin API access"
    Current = if ($adminApiSetting.Enabled) { "Enabled" } else { "Disabled" }
    EnabledFor = $adminApiSetting.EnabledFor
    Recommendation = "Enable for automation (with security group restriction)"
    Status = if ($adminApiSetting.Enabled) { "OK" } else { "Review" }
    Severity = "Medium"
}

# Publish to web
$publishWebSetting = $allSettings | Where-Object { $_.SettingName -like "*PublishToWeb*" } | Select-Object -First 1

$criticalSettings += [PSCustomObject]@{
    Setting = "Publish to web (public internet)"
    Current = if ($publishWebSetting.Enabled) { "Enabled" } else { "Disabled" }
    EnabledFor = $publishWebSetting.EnabledFor
    Recommendation = "Disable (public data exposure risk)"
    Status = if ($publishWebSetting.Enabled -and $publishWebSetting.EnabledFor -eq "Entire Organization") { "Risk" } else { "OK" }
    Severity = if ($publishWebSetting.Enabled -and $publishWebSetting.EnabledFor -eq "Entire Organization") { "High" } else { "Low" }
}

# Export capabilities
$exportExcelSetting = $allSettings | Where-Object { $_.SettingName -like "*ExportToExcel*" } | Select-Object -First 1

$criticalSettings += [PSCustomObject]@{
    Setting = "Export to Excel"
    Current = if ($exportExcelSetting.Enabled) { "Enabled" } else { "Disabled" }
    EnabledFor = $exportExcelSetting.EnabledFor
    Recommendation = "Enable (common business requirement)"
    Status = if ($exportExcelSetting.Enabled) { "OK" } else { "Review" }
    Severity = "Low"
}

# Sensitivity labels
$sensitivitySetting = $allSettings | Where-Object { 
    $_.SettingName -like "*InformationProtection*" -or 
    $_.Title -like "*sensitivity label*"
} | Select-Object -First 1

$criticalSettings += [PSCustomObject]@{
    Setting = "Sensitivity labels"
    Current = if ($sensitivitySetting.Enabled) { "Enabled" } else { "Disabled" }
    EnabledFor = $sensitivitySetting.EnabledFor
    Recommendation = "Enable for compliance"
    Status = if ($sensitivitySetting.Enabled) { "OK" } else { "Review" }
    Severity = "High"
}

# Guest access
$guestSetting = $allSettings | Where-Object { 
    $_.SettingName -like "*Guest*" -or 
    $_.Title -like "*Guest users*"
} | Select-Object -First 1

if ($guestSetting) {
    $criticalSettings += [PSCustomObject]@{
        Setting = "Guest user access"
        Current = if ($guestSetting.Enabled) { "Enabled" } else { "Disabled" }
        EnabledFor = $guestSetting.EnabledFor
        Recommendation = "Review based on security policy"
        Status = if ($guestSetting.Enabled) { "Review" } else { "OK" }
        Severity = "Medium"
    }
}

# Certification
$certificationSetting = $allSettings | Where-Object { $_.SettingName -like "*Certification*" } | Select-Object -First 1

if ($certificationSetting) {
    $criticalSettings += [PSCustomObject]@{
        Setting = "Dataset certification"
        Current = if ($certificationSetting.Enabled) { "Enabled" } else { "Disabled" }
        EnabledFor = $certificationSetting.EnabledFor
        Recommendation = "Enable for governance"
        Status = if ($certificationSetting.Enabled) { "OK" } else { "Review" }
        Severity = "Medium"
    }
}

# ============================================================================
# ANALYSIS - Risky Settings
# ============================================================================

Write-Host "Identifying risky settings..." -ForegroundColor Yellow

$riskyKeywords = @(
    "PublishToWeb",
    "ShareLinkToEntireOrganization", 
    "AllowExternalDataSharingReceivers",
    "ExportToCsv"
)

$riskySettings = $allSettings | Where-Object { 
    $_.Enabled -eq $true -and 
    ($riskyKeywords | Where-Object { $_.SettingName -like "*$_*" })
} | ForEach-Object {
    [PSCustomObject]@{
        Setting = $_.Title
        EnabledFor = $_.EnabledFor
        Risk = "Public data exposure or unauthorized sharing"
    }
}

# ============================================================================
# ANALYSIS - Admin API Settings for Metadata Scanning
# ============================================================================

Write-Host "Checking Admin API settings..." -ForegroundColor Yellow

$adminApiSettings = $allSettings | Where-Object { 
    $_.SettingName -like "*Admin*" -or 
    $_.SettingName -like "*Metadata*" -or
    $_.Title -like "*admin API*" -or
    $_.Title -like "*enhance*"
} | ForEach-Object {
    [PSCustomObject]@{
        Setting = $_.Title
        Enabled = $_.Enabled
        EnabledFor = $_.EnabledFor
        Impact = "Affects metadata scanning API capabilities"
    }
}

# ============================================================================
# BUILD COMPREHENSIVE HTML REPORT
# ============================================================================

Write-Host "Building HTML report..." -ForegroundColor Yellow

$sb = New-Object System.Text.StringBuilder

# All settings table HTML
$allSettingsTableHtml = ($allSettings | ForEach-Object {
    $statusColor = if ($_.Enabled) { "#28a745" } else { "#6c757d" }
    $statusText = if ($_.Enabled) { "ENABLED" } else { "DISABLED" }
    
    "<tr>
        <td>$($_.Category)</td>
        <td><strong>$($_.Title)</strong><br><small style='color:#666;'>$($_.SettingName)</small></td>
        <td style='text-align:center;'><span style='background: $statusColor; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size:0.85em;'>$statusText</span></td>
        <td>$($_.EnabledFor)</td>
        <td style='font-size:0.85em;'>$($_.AdditionalProperties)</td>
    </tr>"
}) -join "`n"

# Category summary table HTML
$categorySummaryHtml = ($categorySummary | ForEach-Object {
    "<tr>
        <td><strong>$($_.Category)</strong></td>
        <td style='text-align:center;'>$($_.Total)</td>
        <td style='text-align:center; color:#28a745;'><strong>$($_.Enabled)</strong></td>
        <td style='text-align:center; color:#6c757d;'>$($_.Disabled)</td>
        <td>
            <div style='background:#e9ecef; border-radius:10px; overflow:hidden; height:20px;'>
                <div style='background:linear-gradient(90deg,#28a745,#20c997); width:$($_.EnabledPercentage)%; height:100%; display:flex; align-items:center; justify-content:center; color:white; font-size:0.75em; font-weight:600;'>
                    $($_.EnabledPercentage)%
                </div>
            </div>
        </td>
    </tr>"
}) -join "`n"

# Critical settings table HTML
$criticalSettingsHtml = ($criticalSettings | ForEach-Object {
    $severityColor = switch ($_.Severity) {
        "High" { "#dc3545" }
        "Medium" { "#ffc107" }
        "Low" { "#17a2b8" }
        default { "#6c757d" }
    }
    
    $statusBadge = switch ($_.Status) {
        "OK" { "<span style='background:#d4edda; color:#155724; padding:4px 10px; border-radius:12px; font-size:0.8em; font-weight:600;'>‚úì OK</span>" }
        "Review" { "<span style='background:#fff3cd; color:#856404; padding:4px 10px; border-radius:12px; font-size:0.8em; font-weight:600;'>‚ö† Review</span>" }
        "Risk" { "<span style='background:#f8d7da; color:#721c24; padding:4px 10px; border-radius:12px; font-size:0.8em; font-weight:600;'>üö® Risk</span>" }
        default { $_.Status }
    }
    
    "<tr>
        <td><strong>$($_.Setting)</strong></td>
        <td style='text-align:center;'>$($_.Current)</td>
        <td>$($_.EnabledFor)</td>
        <td>$($_.Recommendation)</td>
        <td style='text-align:center;'><span style='background:$severityColor; color:white; padding:4px 10px; border-radius:12px; font-size:0.8em; font-weight:600;'>$($_.Severity)</span></td>
        <td style='text-align:center;'>$statusBadge</td>
    </tr>"
}) -join "`n"

# Risky settings HTML
$riskySettingsHtml = if ($riskySettings) {
    ($riskySettings | ForEach-Object {
        "<div class='alert alert-danger'>
            <strong>‚ö†Ô∏è $($_.Setting)</strong><br>
            Enabled for: $($_.EnabledFor)<br>
            <small>Risk: $($_.Risk)</small>
        </div>"
    }) -join "`n"
} else {
    "<div class='alert alert-success'><strong>‚úì No high-risk settings enabled for entire organization</strong></div>"
}

# Admin API settings HTML
$adminApiHtml = ($adminApiSettings | ForEach-Object {
    $statusColor = if ($_.Enabled) { "#d4edda" } else { "#fff3cd" }
    $statusIcon = if ($_.Enabled) { "‚úì" } else { "‚ö†Ô∏è" }
    
    "<div style='background:$statusColor; padding:15px; margin:10px 0; border-radius:8px; border-left:4px solid #667eea;'>
        <strong>$statusIcon $($_.Setting)</strong><br>
        <small style='color:#666;'>Status: $(if ($_.Enabled) { 'Enabled' } else { 'Disabled' }) | Enabled for: $($_.EnabledFor)</small><br>
        <small style='color:#666;'>$($_.Impact)</small>
    </div>"
}) -join "`n"

# Build complete HTML
[void]$sb.AppendLine(@"
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power BI Tenant Settings Report - $reportDate</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        header h1 { font-size: 2.5em; margin-bottom: 10px; }
        header p { font-size: 1.1em; opacity: 0.9; }
        .section { background: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section h2 { color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.8em; }
        .section h3 { color: #764ba2; margin-top: 25px; margin-bottom: 15px; font-size: 1.3em; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #667eea; color: white; padding: 12px; text-align: left; font-weight: 600; position: sticky; top: 0; }
        td { padding: 10px 12px; border-bottom: 1px solid #e0e0e0; }
        tr:hover { background: #f8f9fa; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric-card { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; }
        .metric-card h4 { color: #555; font-size: 0.9em; margin-bottom: 10px; text-transform: uppercase; }
        .metric-card .value { font-size: 2em; font-weight: bold; color: #333; }
        .alert { padding: 15px 20px; border-radius: 8px; margin: 15px 0; border-left: 4px solid; }
        .alert-danger { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .alert-warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .alert-success { background: #d4edda; border-color: #28a745; color: #155724; }
        footer { text-align: center; padding: 30px; color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öôÔ∏è Power BI Tenant Settings Report</h1>
            <p>Generated: $reportDate</p>
            <p>Source: Fabric API (api.fabric.microsoft.com)</p>
        </header>
        
        <!-- SUMMARY METRICS -->
        <div class="section">
            <h2>üìä Summary</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <h4>Total Settings</h4>
                    <div class="value">$($allSettings.Count)</div>
                </div>
                <div class="metric-card">
                    <h4>Enabled</h4>
                    <div class="value" style="color:#28a745;">$(($allSettings | Where-Object { $_.Enabled -eq $true }).Count)</div>
                </div>
                <div class="metric-card">
                    <h4>Disabled</h4>
                    <div class="value" style="color:#6c757d;">$(($allSettings | Where-Object { $_.Enabled -eq $false }).Count)</div>
                </div>
                <div class="metric-card">
                    <h4>Categories</h4>
                    <div class="value">$($categorySummary.Count)</div>
                </div>
            </div>
        </div>
        
        <!-- CRITICAL SETTINGS -->
        <div class="section">
            <h2>üîç Critical Settings Review</h2>
            <table>
                <thead>
                    <tr>
                        <th>Setting</th>
                        <th>Current</th>
                        <th>Enabled For</th>
                        <th>Recommendation</th>
                        <th>Severity</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    $criticalSettingsHtml
                </tbody>
            </table>
        </div>
        
        <!-- RISKY SETTINGS -->
        <div class="section">
            <h2>‚ö†Ô∏è Risky Settings Analysis</h2>
            $riskySettingsHtml
        </div>
        
        <!-- ADMIN API SETTINGS -->
        <div class="section">
            <h2>üîå Admin API Settings (for Metadata Scanning)</h2>
            <p>These settings affect your ability to use admin APIs for governance and metadata extraction.</p>
            $adminApiHtml
        </div>
        
        <!-- CATEGORY BREAKDOWN -->
        <div class="section">
            <h2>üìÅ Settings by Category</h2>
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th style="text-align:center;">Total</th>
                        <th style="text-align:center;">Enabled</th>
                        <th style="text-align:center;">Disabled</th>
                        <th>Enabled %</th>
                    </tr>
                </thead>
                <tbody>
                    $categorySummaryHtml
                </tbody>
            </table>
        </div>
        
        <!-- ALL SETTINGS TABLE -->
        <div class="section">
            <h2>üìã All Tenant Settings</h2>
            <p>Complete list of all $($allSettings.Count) tenant settings. Use Ctrl+F to search.</p>
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Setting</th>
                        <th style="text-align:center;">Status</th>
                        <th>Enabled For</th>
                        <th>Additional Properties</th>
                    </tr>
                </thead>
                <tbody>
                    $allSettingsTableHtml
                </tbody>
            </table>
        </div>
        
        <footer>
            <p>Power BI Tenant Settings Report | Generated: $reportDate</p>
            <p>CSV Export: $csvPath</p>
        </footer>
    </div>
</body>
</html>
"@)

# Save HTML
$htmlPath = "PowerBI_TenantSettings_Report_$timestamp.html"
$sb.ToString() | Out-File -FilePath $htmlPath -Encoding UTF8

Write-Host "`n========================================" -ForegroundColor Green
Write-Host "‚úì EXPORT COMPLETE" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Green
Write-Host "CSV File:  $csvPath" -ForegroundColor White
Write-Host "HTML Report: $htmlPath" -ForegroundColor White
Write-Host "`nOpening HTML report..." -ForegroundColor Cyan

Start-Process $htmlPath

Write-Host "`n‚úì Done!" -ForegroundColor Green
